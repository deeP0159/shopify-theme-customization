<div class="collection-page">
  <div class="collection-header">
    <h1>{{ collection.title }}</h1>
    {% if collection.description %}
      <p class="collection-description">{{ collection.description }}</p>
    {% endif %}
  </div>

  <div class="collection-filters">
    <div class="sort-container">
      <label for="sort">Sort by:</label>
      <select id="sort" onchange="location = this.value;">
        <option value="{{ collection.url }}">Featured</option>
        <option value="{{ collection.url }}? sort_by=title-ascending">Title: A-Z</option>
        <option value="{{ collection.url }}?sort_by=title-descending">Title: Z-A</option>
        <option value="{{ collection.url }}?sort_by=price-ascending">Price: Low to High</option>
        <option value="{{ collection.url }}? sort_by=price-descending">Price: High to Low</option>
        <option value="{{ collection.url }}?sort_by=created-descending">Newest</option>
      </select>
    </div>
  </div>

  <div class="products-grid">
    {% if collection.products.size > 0 %}
      {% for product in collection.products %}
        <div class="product-card">
          <a href="{{ product.url }}" class="product-image-link">
            <img
              src="{{ product.featured_image | image_url: width: 300 }}"
              alt="{{ product.title }}"
              height="600"
              width="600"
              loading="lazy"
            >
            {% if product.compare_at_price > product.price %}
              <span class="sale-badge">Sale</span>
            {% endif %}
          </a>

          <div class="product-info">
            <h3 class="product-title">
              <a href="{{ product.url }}">{{ product.title }}</a>
            </h3>

            <div class="product-price">
              {% if product.compare_at_price > product.price %}
                <span class="original-price">{{ product.compare_at_price | money }}</span>
              {% endif %}
              <span class="current-price">{{ product.price | money }}</span>
            </div>

            <button class="add-to-cart-btn" data-add-to-cart-global="{{ product.variants. first.id }}">
              Add to Cart
            </button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="no-products">
        <p>No products found in this collection.</p>
      </div>
    {% endif %}
  </div>

  {% paginate collection.products by 12 %}
    <div class="pagination">
      {{ paginate | default_pagination }}
    </div>
  {% endpaginate %}
</div>
{% section 'recently-viewed-products' %}

<style>
  .collection-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  .collection-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  . collection-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: #000;
  }

  .collection-description {
    font-size: 1.1rem;
    color: #666;
    line-height: 1.6;
    max-width: 600px;
    margin: 0 auto;
  }

  .collection-filters {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #f5f5f5;
    border-radius: 8px;
  }

  .sort-container {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .sort-container label {
    font-weight: 600;
    color: #333;
  }

  .sort-container select {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    font-size: 1rem;
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
  }

  . product-card {
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid #e0e0e0;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
  }

  .product-image-link {
    position: relative;
    display: block;
    overflow: hidden;
    background: #f5f5f5;
  }

  .product-image-link img {
    width: 100%;
    height: 300px;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  . product-card:hover .product-image-link img {
    transform: scale(1.05);
  }

  .sale-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: #d32f2f;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.85rem;
  }

  . product-info {
    padding: 1.5rem;
  }

  .product-title {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.3;
  }

  .product-title a {
    color: #000;
    text-decoration: none;
  }

  .product-title a:hover {
    color: #667eea;
  }

  .product-price {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 1.25rem;
    font-weight: 600;
  }

  .original-price {
    text-decoration: line-through;
    color: #999;
    font-size: 1rem;
  }

  .current-price {
    color: #000;
  }

  .add-to-cart-btn {
    width: 100%;
    padding: 0.75rem;
    background: #000;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
  }

  .add-to-cart-btn:hover {
    background: #333;
  }

  .no-products {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem 2rem;
    color: #666;
  }

  . pagination {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 3rem;
  }

  @media (max-width: 768px) {
    .collection-header h1 {
      font-size: 1.75rem;
    }

    . collection-filters {
      flex-direction: column;
      align-items: flex-start;
    }

    .products-grid {
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }

    .product-image-link img {
      height: 200px;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const addButtons = document.querySelectorAll('[data-add-to-cart-global]');

    addButtons.forEach((button) => {
      button.addEventListener('click', function (e) {
        e.preventDefault();

        // Disable button while adding
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = 'Adding...';

        const variantId = this.getAttribute('data-add-to-cart-global');

        fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            items: [
              {
                id: Number(variantId),
                quantity: 1,
              },
            ],
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            // Reset button
            button.disabled = false;
            button.textContent = 'Added!';

            setTimeout(() => {
              button.textContent = originalText;
            }, 2000);

            // Update cart and open drawer
            window.dispatchEvent(new CustomEvent('cart:updated', { detail: data }));
            if (window.openCartDrawer) {
              window.openCartDrawer();
            }
          })
          .catch((error) => {
            console.error('Error adding to cart:', error);
            button.disabled = false;
            button.textContent = originalText;
            alert('Error adding item to cart.');
          });
      });
    });
  });
</script>
